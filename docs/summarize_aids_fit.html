<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title></title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Example use cases for stan_jm</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="analysis_of_aids_data.html">Analysis of `AIDS` data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="summarize-drug-comparison" class="section level1">
<h1>Summarize drug comparison</h1>
<p>Jacki Novik 5/4/2017</p>
<div id="data-summary" class="section level2">
<h2>Data summary</h2>
<p>We are analyzing data from the <code>aids</code> dataset, provided by the <a href="https://cran.r-project.org/web/packages/JM/index.html">JM package</a>.</p>
<p>A brief description of the data are provided in the <a href="https://rdrr.io/cran/JM/man/aids.html">package documentation</a>, with more detail in <a href="https://www.ncbi.nlm.nih.gov/pubmed/8556398">the original manuscript</a>.</p>
<p>For our purposes, it’s perhaps sufficient know that we are looking at data from a clinical trial published in 1996. This trial enrolled 467 patients with an HIV diagnosis who were either intolerant or resistant to AZT treatment. Patients were randomized to receive one of two drugs - we will call them <code>ddI</code> (didanosine) and <code>ddC</code> (zalcitabine).</p>
<p>Data are provided in two formats -</p>
<ul>
<li><code>aids</code> contains longitudinal measures (several obs per patient)</li>
<li><code>aids.id</code> contains values at time of randomization (one obs per patient)</li>
</ul>
<pre class="r"><code>data(aids, package = &quot;JM&quot;)
data(aids.id, package = &quot;JM&quot;)</code></pre>
<div id="survival-submodel" class="section level3">
<h3>Survival submodel</h3>
<div id="data-exploration" class="section level4">
<h4>Data exploration</h4>
<p>Overall, there is differential survival according to treatment.</p>
<pre class="r"><code>aids.id %&gt;%
  survfit(Surv(Time, death) ~ drug, data = .) %&gt;%
  ggsurvplot(risk.table = FALSE,
             risk.table.y.text = FALSE,
             #ncensor.plot = TRUE,
             #surv.median.line=&#39;v&#39;,
             conf.int = TRUE,
             size = 0.5, 
             xlab = &#39;months&#39;,
             data = aids.id) +
  ggtitle(&#39;Survival among all patients&#39;) +
  scale_y_continuous(labels = percent)</code></pre>
<pre><code>## Scale for &#39;y&#39; is already present. Adding another scale for &#39;y&#39;, which
## will replace the existing scale.</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-km-curve-1.png" />

</div>
<p>However, this trial enrolled patients according to previous opportunistic infection status (AIDS vs noAIDS) and according to AZT status (intolerance vs resistant). This prior status has pretty important prognostic value and may impact response to therapy.</p>
<p>Here, for example, are survival curves among patients without prior opportunistic infections (ie, no AIDs at time of enrollment).</p>
<pre class="r"><code>plot_noaids &lt;- aids.id %&gt;%
  dplyr::filter(prevOI == &#39;noAIDS&#39;) %&gt;%
  survfit(Surv(Time, death) ~ drug, data = .) %&gt;%
  ggsurvplot(risk.table = FALSE,
             risk.table.y.text = FALSE,
             #ncensor.plot = TRUE,
             #surv.median.line=&#39;v&#39;,
             conf.int = TRUE,
             size = 0.5, 
             xlab = &#39;months&#39;,
             data = aids.id %&gt;%
               dplyr::filter(prevOI == &#39;noAIDS&#39;)) +
  ggtitle(&#39;Patients without previous infections (no AIDs)&#39;) +
  scale_y_continuous(labels = percent)</code></pre>
<pre><code>## Scale for &#39;y&#39; is already present. Adding another scale for &#39;y&#39;, which
## will replace the existing scale.</code></pre>
<pre class="r"><code>plot_noaids</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-KM-curve-by-prevOI-1.png" />

</div>
<p>By comparison, showing survival among patients with prior opportunitistic infections.</p>
<pre class="r"><code>plot_aids &lt;- aids.id %&gt;%
  dplyr::filter(prevOI == &#39;AIDS&#39;) %&gt;%
  survfit(Surv(Time, death) ~ drug, data = .) %&gt;%
  ggsurvplot(risk.table = FALSE,
             risk.table.y.text = FALSE,
             #ncensor.plot = TRUE,
             surv.median.line=&#39;v&#39;,
             conf.int = TRUE,
             size = 0.5, 
             xlab = &#39;months&#39;,
             data = aids.id %&gt;%
               dplyr::filter(prevOI == &#39;AIDS&#39;)) +
  ggtitle(&#39;Patients with previous opportunistic infections (AIDs)&#39;) +
  scale_y_continuous(labels = percent)</code></pre>
<pre><code>## Scale for &#39;y&#39; is already present. Adding another scale for &#39;y&#39;, which
## will replace the existing scale.</code></pre>
<pre class="r"><code>plot_aids</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-KM-curve-among-aids-1.png" />

</div>
<p>Other important indicators include AZT status</p>
<pre class="r"><code>plot_by_azt &lt;- aids.id %&gt;%
  survfit(Surv(Time, death) ~ AZT, data = .) %&gt;%
  ggsurvplot(risk.table = FALSE,
             risk.table.y.text = FALSE,
             #ncensor.plot = TRUE,
             surv.median.line=&#39;v&#39;,
             conf.int = TRUE,
             size = 0.5, 
             xlab = &#39;months&#39;,
             data = aids.id
             ) +
  ggtitle(&#39;Among all patients&#39;) +
  scale_y_continuous(labels = percent)</code></pre>
<pre><code>## Scale for &#39;y&#39; is already present. Adding another scale for &#39;y&#39;, which
## will replace the existing scale.</code></pre>
<pre class="r"><code>plot_by_azt</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-KM-by-azt-1.png" />

</div>
<p>And gender, although the majority of patients enrolled are male.</p>
<pre class="r"><code>plot_by_gender &lt;- aids.id %&gt;%
  survfit(Surv(Time, death) ~ gender, data = .) %&gt;%
  ggsurvplot(risk.table = FALSE,
             risk.table.y.text = FALSE,
             #ncensor.plot = TRUE,
             surv.median.line=&#39;v&#39;,
             conf.int = TRUE,
             size = 0.5, 
             xlab = &#39;months&#39;,
             data = aids.id
             ) +
  ggtitle(&#39;Among all patients&#39;) +
  scale_y_continuous(labels = percent)</code></pre>
<pre><code>## Scale for &#39;y&#39; is already present. Adding another scale for &#39;y&#39;, which
## will replace the existing scale.</code></pre>
<pre class="r"><code>plot_by_gender</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-KM-by-gender-1.png" />

</div>
</div>
<div id="parameterizing-the-submodel" class="section level4">
<h4>Parameterizing the submodel</h4>
<p>Taking these factors into account, we end up with a survival submodel as follows:</p>
<pre class="r"><code>surv_form &lt;- as.formula(Surv(Time, death) ~ drug*prevOI + gender + AZT)</code></pre>
<p>which has the following MLE estimates from the standard cox-ph model:</p>
<pre class="r"><code>cox.fit &lt;- coxph(surv_form, data = aids.id)
summary(cox.fit)</code></pre>
<pre><code>## Call:
## coxph(formula = surv_form, data = aids.id)
## 
##   n= 467, number of events= 188 
## 
##                       coef exp(coef) se(coef)      z Pr(&gt;|z|)    
## drugddI             1.0139    2.7565   0.4185  2.423   0.0154 *  
## prevOIAIDS          1.8593    6.4194   0.3841  4.840  1.3e-06 ***
## gendermale         -0.3266    0.7213   0.2453 -1.332   0.1830    
## AZTfailure          0.1538    1.1663   0.1635  0.941   0.3468    
## drugddI:prevOIAIDS -0.9269    0.3958   0.4476 -2.071   0.0384 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
##                    exp(coef) exp(-coef) lower .95 upper .95
## drugddI               2.7565     0.3628    1.2138    6.2598
## prevOIAIDS            6.4194     0.1558    3.0235   13.6295
## gendermale            0.7213     1.3863    0.4460    1.1667
## AZTfailure            1.1663     0.8574    0.8465    1.6067
## drugddI:prevOIAIDS    0.3958     2.5266    0.1646    0.9515
## 
## Concordance= 0.645  (se = 0.022 )
## Rsquare= 0.136   (max possible= 0.99 )
## Likelihood ratio test= 68.17  on 5 df,   p=2.467e-13
## Wald test            = 45.72  on 5 df,   p=1.034e-08
## Score (logrank) test = 56.92  on 5 df,   p=5.265e-11</code></pre>
</div>
<div id="including-baseline-value-of-longitudinal-covariate-cd4" class="section level4">
<h4>Including baseline value of longitudinal covariate <code>CD4</code></h4>
<p>The longitudinal endpoint of interest here is <code>CD4</code> count. CD4+ cells are a type of T cell, and they play a critical part of the immune system function. Their levels are often depressed in aids patients, particularly as the disease progresses.</p>
<p>We thus expect higher levels of CD4 count to be associated with improved survival.</p>
<p>Before considering the longitudinal submodel, we should include the baseline value of <code>CD4</code> count in our survival submodel. We do this for two reasons - (1) to sanity check our expectation of improved survival with higher levels of CD4 count, and (2) to see how the inclusion of this covariate impacts our parameter estimates.</p>
<pre class="r"><code>cox.fit2 &lt;- coxph(update(surv_form, ~ . + CD4), data = aids.id)
summary(cox.fit2)</code></pre>
<pre><code>## Call:
## coxph(formula = update(surv_form, ~. + CD4), data = aids.id)
## 
##   n= 467, number of events= 188 
## 
##                       coef exp(coef) se(coef)      z Pr(&gt;|z|)    
## drugddI             1.1513    3.1623   0.4194  2.745 0.006054 ** 
## prevOIAIDS          1.4074    4.0854   0.3867  3.639 0.000273 ***
## gendermale         -0.2173    0.8047   0.2440 -0.891 0.373110    
## AZTfailure          0.1339    1.1433   0.1622  0.825 0.409116    
## CD4                -0.1516    0.8593   0.0237 -6.396  1.6e-10 ***
## drugddI:prevOIAIDS -1.0503    0.3498   0.4484 -2.343 0.019153 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
##                    exp(coef) exp(-coef) lower .95 upper .95
## drugddI               3.1623     0.3162    1.3899    7.1949
## prevOIAIDS            4.0854     0.2448    1.9146    8.7179
## gendermale            0.8047     1.2427    0.4988    1.2981
## AZTfailure            1.1433     0.8747    0.8319    1.5711
## CD4                   0.8593     1.1637    0.8203    0.9002
## drugddI:prevOIAIDS    0.3498     2.8586    0.1453    0.8424
## 
## Concordance= 0.725  (se = 0.022 )
## Rsquare= 0.223   (max possible= 0.99 )
## Likelihood ratio test= 117.9  on 6 df,   p=0
## Wald test            = 81.02  on 6 df,   p=2.22e-15
## Score (logrank) test = 96.08  on 6 df,   p=0</code></pre>
<p>As we suspected, higher <code>CD4</code> count is associated with better prognosis in this cohort. It is also notable that the inclusion of this covariate substantially increases the benefit of drug <code>ddI</code> (didanosine) over <code>ddC</code> (zalcitabine), and lessens the magnitude of association between prior AIDS status and survival, as well as its interaction with the drug effect.</p>
<p>This would suggest that the impact of prior AIDS on survival is explained at least in part by differences in CD4 levels.</p>
<p>Which is indeed the case.</p>
<pre class="r"><code>ggplot(aids.id, aes(x = CD4, group = prevOI, colour = prevOI)) +
  geom_density() +
  theme_minimal() +
  ggtitle(&#39;CD4 count at baseline by previous OI (opportunistic infection) status&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-cd4-baseline-by-prevOI-1.png" />

</div>
<p>Cool. At this point, we are ready to investigate the longitudinal submodel.</p>
</div>
</div>
<div id="longitudinal-submodel" class="section level3">
<h3>Longitudinal submodel</h3>
<p>We now begin to investigate the longitudinal (on-treatment) measurements of <code>CD4</code> count.</p>
<p>As noted above, we would expect higher levels of CD4 count to be associated with improved survival. We also now expect these measurements (at least at baseline) to be correlated with previous AIDS status.</p>
<p>Here we plot trajectories of CD4 count over the course of treatment for each patient, by previous infection status.</p>
<pre class="r"><code>ggplot(aids, aes(x = obstime, y = CD4, group = patient, colour = prevOI)) +
  geom_line(alpha = 0.2) +
  scale_x_continuous(&#39;months&#39;) +
  theme_minimal() +
  ggtitle(&#39;CD4 count over time per patient, according to previous infection status&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-CD4-long-1.png" />

</div>
<p>You will notice that timepoints of collection here are highly regular, although we do have some missing values. At each timepoint, there are also waves of censoring in the longitudinal data.</p>
<p>It is customary to use <code>sqrt(CD4)</code> when modeling these data instead of CD4. Although it’s not strictly necessary for our model, we will proceed with this convention.</p>
<pre class="r"><code>ggplot(aids2 %&gt;% 
         dplyr::mutate(`sqrt(CD4)` = sqrt_cd4) %&gt;%
         tidyr::gather(&#39;variable&#39;, &#39;value&#39;, CD4, `sqrt(CD4)`),
       aes(x = value, group = variable, colour = variable)) + 
  geom_density() +
  facet_wrap(~variable, scales = &#39;free&#39;) +
  theme_minimal() +
  theme(legend.position = &#39;none&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/compare-cd4-sqrt-1.png" />

</div>
<p>Here we are fitting a longitudinal submodel of the form:</p>
<p>(<em>Y</em>|<em>B</em> = <em>b</em>)∼<em>N</em>(<em>X<strong>β<em> + </em>Z</strong>b</em> + <em>o</em>, <em>σ</em><sup>2</sup><em>W</em><sup>−1</sup>)</p>
<p>Where <em>Y</em> is our dependent variable (<code>CD4</code> count), <em>X</em> is a design matrix of covariates affecting <code>CD4</code> count, <em>Z</em> is a design matrix of subject-specific covariate values and <em>b</em> is a set of subject-specific parameters. The specification of the design matrices <em>X</em> and <em>Z</em> is made using <code>lmer</code> formula syntax.</p>
<p>We have fit several parameterizations of the longitudinal submodel using <code>rstanarm::stan_glmer</code></p>
<pre class="r"><code>loo_comp_table %&gt;% dplyr::select(model_name, description) %&gt;% arrange(model_name) %&gt;% dplyr::filter(model_name != &#39;long6&#39;) %&gt;% print(right=F)</code></pre>
<pre><code>##   model_name
## 1 long0     
## 2 long1     
## 3 long2     
## 4 long3     
## 5 long4     
## 6 long5     
##   description                                                                                                               
## 1 sqrt(CD4) ~ obstime + (1 | patient)                                                                                       
## 2 sqrt(CD4) ~ obstime + (1 + obstime | patient)                                                                             
## 3 sqrt(CD4) ~ obstime * drug + (1 + obstime | patient)                                                                      
## 4 sqrt(CD4) ~ obstime + drug + obstime:drug + gender + prevOI + AZT + (1 + obstime | patient)                               
## 5 sqrt(CD4) ~ obstime + drug + obstime:drug + prevOI + obstime:prevOI + gender + AZT + (1 + obstime | patient)              
## 6 sqrt(CD4) ~ obstime + drug + obstime:drug + prevOI + obstime:prevOI + drug:prevOI + gender + AZT + (1 + obstime | patient)</code></pre>
<p>Using <code>LOO-PSIS</code> as a model-comparison criterion, we can sort models from the best fit (<code>long3</code>) to the worst (<code>long0</code>).</p>
<pre class="r"><code>loo_comp_table %&gt;% dplyr::select(model_name, looic, se_looic) %&gt;% print(right=F)</code></pre>
<pre><code>##   model_name looic    se_looic
## 1 long3      1926.718 91.69184
## 2 long2      1930.031 90.83887
## 3 long5      1930.792 92.13360
## 4 long4      1932.482 92.60514
## 5 long6      1933.828 91.95204
## 6 long1      1952.837 93.82012
## 7 long0      2044.633 94.16735</code></pre>
<p>From the perspective of model comparison, there are a few things to note:</p>
<ol style="list-style-type: decimal">
<li>The biggest improvements in fit came from:
<ul>
<li>allowing slope of <code>CD4</code> over time to vary by patient (long0 -&gt; long1)</li>
<li>including tx effect &amp; allowing slope of <code>CD4</code> over time to vary by tx (long1 -&gt; long2)</li>
<li>including covariate effects of for <code>prevOI</code> and <code>AZT</code> (long2 -&gt; long3)</li>
</ul></li>
<li>There was very little improvement in fit when we included an interaction between the slope of <code>CD4</code> (<code>obstime</code>) &amp; <code>prevOI</code> (long4), whether this was included with or without interactions between drug &amp; <code>prevOI</code> or other interaction effects.</li>
</ol>
<p>I would also note the slight interaction effect between drug (<code>ddI</code>) and <code>obstime</code>, since any differential survival due to treatment might be mediated by effect of treatment on the rate of change in <code>CD4</code>.</p>
<p>Let’s summarize the posterior parameter estimates for <code>long3</code>.</p>
<pre class="r"><code>long3 &lt;- readRDS(file = file.path(CACHE_DIR, &#39;long3.rds&#39;))
print(long3)</code></pre>
<pre><code>## stan_glmer(formula = sqrt(CD4) ~ obstime + drug + obstime:drug + 
##     gender + prevOI + AZT + (1 + obstime | patient), data = aids)
## 
## Estimates:
##                 Median MAD_SD
## (Intercept)      3.1    0.1  
## obstime          0.0    0.0  
## drugddI          0.1    0.1  
## gendermale       0.0    0.1  
## prevOIAIDS      -0.9    0.1  
## AZTfailure      -0.1    0.1  
## obstime:drugddI  0.0    0.0  
## sigma            0.4    0.0  
## 
## Error terms:
##  Groups   Name        Std.Dev. Corr 
##  patient  (Intercept) 0.763         
##           obstime     0.037    -0.05
##  Residual             0.369         
## Num. levels: patient 467 
## 
## Sample avg. posterior predictive 
## distribution of y (X = xbar):
##          Median MAD_SD
## mean_PPD 2.5    0.0   
## 
## ------
## For info on the priors used see help(&#39;prior_summary.stanreg&#39;).</code></pre>
<p>While it’s important to note that inferences from this model aren’t valid (due to data not missing at random), we can still investigate the population-level parameter estimates from the model. Mostly because it will be useful to compare these estimates to those obtained from the joint model.</p>
<pre class="r"><code>bayesplot::mcmc_areas(as.array(long3), pars = colnames(coefficients(long3)$patient)[-1]) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Posterior parameter estimates for model fit with stan_lmer&#39;, subtitle = &#39;Long3: longitudinal model for assoc with sqrt(CD4) over time (obstime)&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/plot-population-level-parameters-1.png" />

</div>
<p>As expected, the CD4 count is generally decreasing in this population – this is a very sick population (remember this is in 1996!). Also, as expected, having had a prior opportunistic infection (<code>prevOIAIDS</code>) leads to lower initial values of <code>CD4</code>. Similarly, having had prior AZT failure may confer a worse prognosis.</p>
<p>In order to obtain valid inferences for these parameters, we would need to use the Joint Model which adjusts for the informative censoring due to clinical events.</p>
</div>
<div id="joint-model-for-longitudinal-biomarker-survival-event-data" class="section level3">
<h3>Joint model for longitudinal biomarker + survival event data</h3>
<p>At this point we are ready to fit the joint model for longitudinal &amp; time-to-event data.</p>
<p>We start with a fit incorporating our work on the individual submodels.</p>
<pre class="r"><code>print(f7)</code></pre>
<pre><code>## stan_jm(formulaLong = sqrt_cd4 ~ obstime + drug + obstime:drug + 
##     gender + prevOI + AZT + (1 + obstime | patient), dataLong = aids2, 
##     formulaEvent = Surv(Time, death) ~ drug + prevOI + drug:prevOI + 
##         gender + AZT, dataEvent = aids.id, time_var = &quot;obstime&quot;, 
##     assoc = c(&quot;etavalue&quot;, &quot;etaslope&quot;), basehaz = &quot;bs&quot;, chains = 4, 
##     adapt_delta = 0.999)
## 
## Longitudinal submodel: sqrt_cd4
##                 Median MAD_SD
## (Intercept)      3.080  0.136
## obstime         -0.042  0.005
## drugddI          0.061  0.074
## gendermale      -0.002  0.135
## prevOIAIDS      -0.870  0.091
## AZTfailure      -0.072  0.092
## obstime:drugddI  0.004  0.007
## sigma            0.370  0.011
## 
## Event submodel:
##                    Median MAD_SD exp(Median)
## drugddI             1.171  0.405  3.225     
## prevOIAIDS          1.301  0.392  3.672     
## gendermale         -0.337  0.254  0.714     
## AZTfailure          0.131  0.173  1.140     
## drugddI:prevOIAIDS -0.960  0.448  0.383     
## Long1|etavalue     -0.957  0.142  0.384     
## Long1|etaslope     -3.662  5.712  0.026     
## basehaz-coef1      -4.504  0.846     NA     
## basehaz-coef2      -1.985  0.776     NA     
## basehaz-coef3      -3.670  0.763     NA     
## basehaz-coef4      -1.447  0.786     NA     
## basehaz-coef5      -3.530  1.004     NA     
## basehaz-coef6      -2.380  1.392     NA     
## 
## Group-level random effects:
##  Groups  Name              Std.Dev. Corr
##  patient Long1|(Intercept) 0.76272      
##          Long1|obstime     0.03671  0.02
## Num. levels: patient 467</code></pre>
<p>Let’s see how closely the estimated ‘bs’ baseline hazard matches our observed KM curves.</p>
<pre class="r"><code>f7.ps_check</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/jm-ps_check-1.png" />

</div>
<div id="summarize-parameter-estimates-graphically" class="section level4">
<h4>Summarize parameter estimates graphically</h4>
<pre class="r"><code>bayesplot::mcmc_areas(as.array(f7), pars = paste(&#39;Long1&#39;, colnames(coefficients(long3)$patient)[-1], sep = &#39;|&#39;)) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Posterior parameter estimates for model fit with stan_jm&#39;, subtitle = &#39;f7: longitudinal submodel for assoc with sqrt(CD4) over time (obstime)&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/show-coefs-long-1.png" />

</div>
<p>Here we see increased <em>hazard</em> (worse survival) with prior opportunistic infections, prior AZT failure, and treatment with <code>ddI</code> (didanosine).</p>
<p>For example, the typical trajectory for a patient varies according to <code>prevOI</code> and <code>obstime</code>, with very little variation due to treatment.</p>
<pre class="r"><code>newdata &lt;- purrr::cross_d(list(prevOI = c(&#39;AIDS&#39;, &#39;noAIDS&#39;),
                       obstime = aids2 %&gt;% dplyr::distinct(obstime) %&gt;% unlist(),
                       drug = c(&#39;ddI&#39;, &#39;ddC&#39;)
                       )) 

newdata.id &lt;- newdata %&gt;%
  dplyr::distinct(prevOI, drug) %&gt;%
  dplyr::mutate(patient = 2000 + row_number()) %&gt;%
  dplyr::mutate(gender = &#39;male&#39;,
                AZT = &#39;failure&#39;)

newdata &lt;- newdata %&gt;%
  dplyr::inner_join(newdata.id, by = c(&#39;prevOI&#39;, &#39;drug&#39;))

pplong &lt;- posterior_predict(
  f7,
  m = 1,
  newdata = newdata
)
pplong_df &lt;- newdata %&gt;%
  dplyr::bind_cols(as.data.frame(posterior_interval(pplong))) %&gt;%
  dplyr::bind_cols(as.data.frame(posterior_interval(pplong, prob = 0.01))) %&gt;%
  dplyr::mutate(median = (`49.5%` + `50.5%`)/2)

ggplot(pplong_df, aes(x = obstime, y = median, colour = drug, group = drug)) +
  geom_line() +
  facet_wrap(~prevOI) +
  geom_ribbon(aes(ymin = `5%`, ymax = `95%`, colour = NULL, fill = drug), alpha = 0.2) +
  theme_minimal() +
  ggtitle(&#39;Posterior predicted values for prevOI X drug interaction&#39;) +
  scale_x_continuous(&#39;Months&#39;) +
  scale_y_continuous(&#39;sqrt(CD4)&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/unnamed-chunk-1-1.png" />

</div>
<p>There is better overall survival among men than women, but there isn’t a lot of confidence in this signal.</p>
<p>These coefficient estimates are consistent with what we saw in the exploratory analysis &amp; the MLE estimates obtained using <code>coxph</code>.</p>
<pre class="r"><code>bayesplot::mcmc_areas(as.array(f7), regex_pars = &#39;^Event\\|[^basehaz]&#39;) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Posterior parameter estimates for model fit with stan_jm&#39;,
          subtitle = &#39;Event submodel for hazard of mortality&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/show-coefs-event-1.png" />

</div>
<p>Let’s look at the coefficients for <code>Assoc</code>, which relates the longitudinal submodel to the event submodel.</p>
<pre class="r"><code>bayesplot::mcmc_areas(as.array(f7), regex_pars = &#39;^Assoc\\|&#39;) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Posterior parameter estimates for model fit with stan_jm&#39;,
          subtitle = &#39;Association between longitudinal submodel &amp; event submodel (hazard)&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/show-coefs-assoc-1.png" />

</div>
<p>We see a very narrow but somewhat certain association of <code>etavalue</code> (the current value at any time of <code>CD4</code> count) and subsequent mortality. This is an inverse association, so that higher <code>CD4</code> counts yield improved survival (as we expect).</p>
<p>There is also a weak but plausible trend towards improved survival with increasing slopes of <code>CD4</code> count.</p>
</div>
<div id="compare-long-model-coefficients" class="section level4">
<h4>Compare long-model coefficients</h4>
<p>Next we compare coefficient values from the longitudinal model fit to their counterparts in the <code>stan_jm</code> fit.</p>
<pre class="r"><code>p_joint &lt;- bayesplot::mcmc_areas(as.array(f7), pars = paste(&#39;Long1&#39;, colnames(coefficients(long3)$patient)[-1], sep = &#39;|&#39;)) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Fit within Joint Model&#39;)

p_long &lt;- bayesplot::mcmc_areas(as.array(long3), pars = colnames(coefficients(long3)$patient)[-1]) + 
  bayesplot::vline_0() +
  ggtitle(&#39;Fit as standalone&#39;)

bayesplot::bayesplot_grid(p_joint, p_long,
                          grid_args = list(ncol = 2),
                          xlim = c(-1.2, 0.5))</code></pre>
<pre><code>## Scale for &#39;x&#39; is already present. Adding another scale for &#39;x&#39;, which
## will replace the existing scale.
## Scale for &#39;x&#39; is already present. Adding another scale for &#39;x&#39;, which
## will replace the existing scale.</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/compare-coefs-long-1.png" />

</div>
</div>
</div>
<div id="summarizing-model-for-example-patients" class="section level3">
<h3>Summarizing model for example patients</h3>
<p>At the population level, how is the outcome different among patients with an AIDS diagnosis, depending on treatment?</p>
<p>Here we will consider only data known at baseline, then draw from the posterior predictive distribution under two treatment scenarios.</p>
<pre class="r"><code>with_aids_ddI_ppsurv %&gt;% 
         dplyr::mutate(drug = &#39;ddI&#39;, prevOI = &#39;AIDS&#39;) %&gt;%
         dplyr::bind_rows(with_aids_ddC_ppsurv %&gt;% dplyr::mutate(drug = &#39;ddC&#39;, prevOI = &#39;AIDS&#39;)) %&gt;%
         dplyr::bind_rows(no_aids_ddI_ppsurv %&gt;% dplyr::mutate(drug = &#39;ddI&#39;, prevOI = &#39;noAIDS&#39;)) %&gt;%
         dplyr::bind_rows(no_aids_ddC_ppsurv %&gt;% dplyr::mutate(drug = &#39;ddC&#39;, prevOI = &#39;noAIDS&#39;)) %&gt;%
  ggplot(.,
       aes(x = obstime, y = survpred, group = drug, colour = drug)) +
  geom_line() +
  geom_ribbon(aes(ymin = ci_lb, ymax = ci_ub, colour = NULL, fill = drug), alpha = 0.2) +
  facet_wrap(~prevOI) +
  theme_minimal() +
  scale_y_continuous(&#39;Posterior-predicted survival&#39;, labels = percent) +
  scale_x_continuous(&#39;Months&#39;)</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/summ-drug-effect-aids-1.png" />

</div>
</div>
</div>
<div id="the-decision-problem" class="section level2">
<h2>The decision problem</h2>
<p>Now we get to the crux of the issue - namely, informing the treatment plan for an individual patient.</p>
<p>Given the model, you might think that we could simply treat all patients with <code>ddC</code>, since <code>ddI</code> is associated with higher hazard for mortality.</p>
<p>However, the picture may not be that simple.</p>
<p>First, the model is not simple. We have an interaction effect between treatment status &amp; prevOI, but we also have slightly higher <code>CD4</code> counts with <code>ddI</code> (which is associated with improved survival) and slightly higher hazard with <code>ddI</code> (which is thus associated with worse survival). Our model also measures the drug effect <em>holding all other covariates equal</em> .. including <code>CD4</code> count. But <code>CD4</code> count as we have seen often varies over time and differently for different patients.</p>
<p>Second, even if our model <em>were</em> simple, the decision problem is itself complex.</p>
<p>Consider:</p>
<ol style="list-style-type: decimal">
<li>The survival benefit of <code>ddC</code> over <code>ddI</code> may not be the same over all patients.
<ul>
<li>There may be a subset of patients for whom <code>ddI</code> is just as good as <code>ddC</code></li>
<li>There may also be a subset of patients for whom <code>ddI</code> is better than <code>ddC</code></li>
<li>The relative benefit of each drug may <em>change</em> over the course of treatment</li>
</ul></li>
<li>In addition, survival is not the only outcome to consider.
<ul>
<li>The side-effects from the two drugs may not be comparable</li>
<li>The risk of adverse events may vary by patient, and/or by drug</li>
<li>The two drugs may not have the same cost</li>
</ul></li>
</ol>
<p>In practice, we want to consider all of these factors when making a treatment decision.</p>
<div id="example---estimating-treatment-effects" class="section level3">
<h3>Example - estimating treatment effects</h3>
<p>For lack of a better name, we will call this first problem ‘heterogenous treatment effects’. We will call the second problem the ‘decision problem’.</p>
<div id="plot-expected-survival-over-time" class="section level4">
<h4>Plot expected survival over time</h4>
<p>To start with a simple example, let’s consider the case for a few patients.</p>
<pre class="r"><code># plot expected survival probabilities under two scenarios
patient_ppsurv %&gt;%
  dplyr::left_join(patient_data.id %&gt;% dplyr::select(-obstime), by = &#39;patient&#39;) %&gt;%
  dplyr::bind_rows(patient_ppsurv_alt %&gt;%
                     dplyr::left_join(patient_data_alt.id %&gt;% dplyr::select(-obstime), by = &#39;patient&#39;)
                   ) %&gt;%
  dplyr::arrange(prevOI, patient) %&gt;%
  ggplot(., aes(x = obstime, y = survpred, group = drug, colour = drug)) +
  geom_line() +
  geom_ribbon(aes(ymin = ci_lb, ymax = ci_ub, fill = drug, colour = NULL), alpha = 0.4) +
  facet_wrap(prevOI~patient) +
  theme_minimal() +
  scale_x_continuous(&#39;Months following treatment&#39;) +
  scale_y_continuous(&#39;Survival probability&#39;, labels = percent)</code></pre>
<pre><code>## Warning in bind_rows_(x, .id): binding factor and character vector,
## coercing into character vector</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/example-patients-baseline-plot-predcurve-1.png" />

</div>
</div>
<div id="plot-expected-cd4-counts-over-time" class="section level4">
<h4>Plot expected CD4 counts over time</h4>
<pre class="r"><code># plot expected `CD4` counts under two scenarios
patient_ppint %&gt;% 
  dplyr::bind_rows(patient_ppint_alt) %&gt;%
  ggplot(., aes(x = obstime, y = median, group = drug, colour = drug)) + 
  geom_line() +
  facet_wrap(prevOI ~ patient) +
  geom_ribbon(aes(ymin = `5%`, ymax = `95%`, colour = NULL, fill = drug), alpha = 0.2) +
  theme_minimal() +
  scale_y_continuous(&#39;CD4 count&#39;)</code></pre>
<pre><code>## Warning in bind_rows_(x, .id): binding factor and character vector,
## coercing into character vector</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/unnamed-chunk-4-1.png" />

</div>
</div>
</div>
</div>
<div id="look-at-model-f8" class="section level2">
<h2>Look at model <code>f8</code></h2>
<p>As a comparison, look at model <code>f8</code> which includes CD4 count at baseline as a covariate in the survival submodel.</p>
<pre class="r"><code>f8 &lt;- readRDS(file.path(CACHE_DIR, &#39;f8.rds&#39;))
print(f8)</code></pre>
<pre><code>## stan_jm(formulaLong = sqrt_cd4 ~ obstime + drug + obstime:drug + 
##     gender + prevOI + AZT + (1 + obstime | patient), dataLong = aids2, 
##     formulaEvent = Surv(Time, death) ~ drug + prevOI + drug:prevOI + 
##         gender + AZT + CD4, dataEvent = aids.id, time_var = &quot;obstime&quot;, 
##     assoc = c(&quot;etavalue&quot;, &quot;etaslope&quot;), basehaz = &quot;bs&quot;, chains = 4, 
##     adapt_delta = 0.999)
## 
## Longitudinal submodel: sqrt_cd4
##                 Median MAD_SD
## (Intercept)      3.085  0.133
## obstime         -0.042  0.005
## drugddI          0.065  0.076
## gendermale      -0.002  0.121
## prevOIAIDS      -0.871  0.096
## AZTfailure      -0.078  0.093
## obstime:drugddI  0.005  0.007
## sigma            0.370  0.011
## 
## Event submodel:
##                    Median MAD_SD exp(Median)
## drugddI             1.137  0.424  3.116     
## prevOIAIDS          1.266  0.379  3.546     
## gendermale         -0.354  0.278  0.702     
## AZTfailure          0.139  0.174  1.149     
## CD4                -0.001  0.064  0.999     
## drugddI:prevOIAIDS -0.915  0.439  0.401     
## Long1|etavalue     -0.958  0.344  0.384     
## Long1|etaslope     -4.069  8.097  0.017     
## basehaz-coef1      -4.514  1.072     NA     
## basehaz-coef2      -1.924  0.974     NA     
## basehaz-coef3      -3.653  0.925     NA     
## basehaz-coef4      -1.414  0.923     NA     
## basehaz-coef5      -3.513  1.070     NA     
## basehaz-coef6      -2.267  1.388     NA     
## 
## Group-level random effects:
##  Groups  Name              Std.Dev. Corr
##  patient Long1|(Intercept) 0.76535      
##          Long1|obstime     0.03679  0.02
## Num. levels: patient 467</code></pre>
<pre class="r"><code># plot expected survival probabilities under two scenarios
patient_ppsurv8 %&gt;%
  dplyr::left_join(patient_data.id %&gt;% dplyr::select(-obstime), by = &#39;patient&#39;) %&gt;%
  dplyr::bind_rows(patient_ppsurv_alt8 %&gt;%
                     dplyr::left_join(patient_data_alt.id %&gt;% dplyr::select(-obstime), by = &#39;patient&#39;)
                   ) %&gt;%
  dplyr::arrange(prevOI, patient) %&gt;%
  ggplot(., aes(x = obstime, y = survpred, group = drug, colour = drug)) +
  geom_line() +
  geom_ribbon(aes(ymin = ci_lb, ymax = ci_ub, fill = drug, colour = NULL), alpha = 0.4) +
  facet_wrap(prevOI~patient) +
  theme_minimal() +
  scale_x_continuous(&#39;Months following treatment&#39;) +
  scale_y_continuous(&#39;Survival probability&#39;, labels = percent)</code></pre>
<pre><code>## Warning in bind_rows_(x, .id): binding factor and character vector,
## coercing into character vector</code></pre>
<div class="figure">
<img src="summarize_aids_fit_files/figure-markdown_github/example-patients-baseline-plot-predcurve-f8-1.png" />

</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
